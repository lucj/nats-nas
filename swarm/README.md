Below are the commands that needs to be run in order to deploy NATS and NATS account server on a Docker Swarm.

First step is to clone this repo and go into the *swarm* folder.

## Prerequisite

Make sure Docker is installed and the daemon is running in Swarm mode

```
docker swarm init
```

## Deploy NATS Server Account and NATS Server

The following actions are performed:
- create nats_accounts volmume (to handle jwt)
- create nats_nkeys volume (to handle user's creds files)
- create an operator (OP)
- create a system account (SYS) and user (SYSU)
- copy the SYSU creds files locally in the *secrets* folder

```
./deploy-NAS-NATS.sh
```

## Create APP / APPU (admin user)

The following actions are performed:
- create an admin account (APP) and user (APPU)
- admin user is authorized to subscribe and to publish on ">"
- copy the APPU creds files locally in the *secrets* folder

```
./create-admin.sh
```

Make sure the pub/sub is working fine with this user:
(this is using the creds file generated by the previous command)

```terminal1
nats-sub -creds ./secrets/APPU.creds ">"
```

```terminal2
nats-pub -creds ./secrets/APPU.creds ">" hello
```

## Create client account + user

The following actions are performed:
- create an export from APP account on subject "users.user1.>"
- create a client account (user1) and its associated user (user1)
- create an import in account user1 on subject "users.user1.>"
- copy the user1 creds files locally in the *secrets* folder
```
./create-client.sh user1 "users.user1.>"
```

Make sure it's working fine:
(this is using the creds file generated by the previous command)

```terminal1
nats-sub -creds ./secrets/user1.creds "users.user1.>"
Listening on [users.user1.>]
```

```terminal2
nats-pub -creds ./secrets/APPU.creds "users.user1.events" hello
Published [users.user1.events] : 'hello'
```

Currently facing an issue as the user1 does not receive any messages (unless NATS is restarted)
